<!--
Version 1.2

History:
 v1.2 2024-06-01
   - Added Battery SVG objects and code (GizMoCuz)
 
 v1.1 2024-05-31
  - Changed deprecated api url and corrected it to "/json.htm?type=command&param=getdevices&rid="
  - idGas en idSolar can be set to -1 when not used.

 v1.0 2024-05-18
   - First version. (MeneerKees)
   
========================================================   
Notes:

When not using a battery and/or water meter, set the viewBox of the SVG object below to viewBox="0 0 60 40" to remove the empty space below

========================================================
-->
<style type="text/css">
#boxmain {
	background: #eee;
	border-color: #888;
	border-radius: 2vw;
	border-style: solid;
	border-width: 3px;
	color: #000000;
	text-align: center;
	width: 95vw; 
	height: calc(100vh - 130px);
	margin: 0 auto auto auto;
}

#SolarToNet-flow, #SolarToHome-flow, #BattNet-flow, #BattHome-flow, #NetToHome-flow, #SolarToBatt-flow {
	stroke-dasharray: 1; 
	stroke-dashoffset: 10;
}

@keyframes flow {
	100% {
		stroke-dashoffset: 0;
	}
}
</style>

<div id="boxmain">
<?xml version="1.0" encoding="utf-8"?>
<svg width="100%" height="100%" version="1.1" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
  <g id="groupBatt">
    <g transform="matrix(0.010083, 0, 0, 0.008335, 27.65, 45.2)" style="">
      <path d="M319.089,27.221h-36.475V0h-95.27v27.221h-34.607c-22.517,0-40.829,18.317-40.829,40.832v362.946
      c0,22.51,18.317,40.83,40.829,40.83h166.352c22.524,0,40.832-18.32,40.832-40.83V68.052
      C359.921,45.538,341.613,27.221,319.089,27.221z M332.705,431.002c0,7.501-6.108,13.607-13.616,13.607H152.737
      c-7.501,0-13.608-6.095-13.608-13.607V68.052c0-7.501,6.107-13.611,13.608-13.611h166.352c7.508,0,13.616,6.109,13.616,13.611
      V431.002z M317.862,428.5H153.966v-59.719h163.896V428.5z M317.862,354.071H153.966v-59.716h163.896V354.071z M317.862,279.64
      H153.966v-59.72h163.896V279.64z"/>
    </g>
    <line id="SolarToBatt" x1="30" y1="17" x2="30" y2="43" style="stroke:#77eaea;stroke-width:0.6"/>
	<line id="SolarToBatt-flow" x1="30" y1="17" x2="30" y2="43" style="stroke:red;stroke-width:0.2"/>
	<g transform="translate(30.5, 29.2)">
		<text id="textSolarToBatt" fill="#4d4d4d" font-size="1.1px" text-anchor="end" transform="rotate(90)" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">SolarToBatt</text>
	</g>      
    <g fill="none">
      <path id="BattNet" d="m29 43c0 -9 -2 -11 -12 -12" stroke="#ffd000" stroke-width=".6"/>
      <path id="BattNet-flow" d="m29 43c0 -9 -2 -11 -12 -12" stroke="#f00" stroke-linecap="round" stroke-width=".2"/>
      <path id="BattHome" d="m31 43c0 -9 2 -11 12 -12" stroke="#ffd000" stroke-width=".6"/>
      <path id="BattHome-flow" d="m31 43c0 -9 2 -11 12 -12" stroke="#f00" stroke-linecap="round" stroke-width=".2"/>
    </g>
    <text id="textTotalCharge" x="30" y="51.7" fill="#333333" font-size="2.1px" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; font-weight: bold; white-space: pre;">80%</text>
    <text id="textActualBatt" x="30" y="54" fill="#333333" font-size="1.6px" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; font-weight: bold; white-space: pre;">ActualBatt</text>
    <text id="textActualBattNet" x="26" y="35" fill="#4d4d4d" font-size="1.1px" text-align="end" text-anchor="end" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">ActualBattNet</text>
    <text id="textActualBattHome" x="34" y="35" fill="#4d4d4d" font-family="Arial" font-size="1.1px" stroke-linecap="round" stroke-width=".38" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">ActualBattHome</text>
    <rect id="rectBatt" x="23" y="43" width="14" height="14" ry="7" fill="none" stroke="#90e090" stroke-linecap="round" stroke-width=".3"/>
  </g>
  <g id="groupSolar">
    <g id="pathIconSolar" transform="matrix(0.0095, 0, 0, 0.0095, 27, 4.5)">
    	<path d="M77.604,241.753l10.047-41.623c-21.697-9.842-38.879-39.91-38.879-65.383c0-40.4,32.761-73.162,73.162-73.162
    		c31.978,0,59.097,20.563,69.049,49.153h28.136c4.574-7.435,17.672-17.408,15.484-22.67c-2.766-6.681-27.566-1.566-31.546-7.515
    		c-4.003-5.979,10.172-26.951,5.1-32.022c-5.078-5.078-26.05,9.104-32.029,5.093c-5.941-3.973-0.834-28.788-7.508-31.553
    		c-6.572-2.722-20.497,18.396-27.639,16.984c-6.922-1.368-11.723-26.241-19.048-26.241c-7.325,0-12.126,24.873-19.048,26.241
    		c-7.134,1.412-21.06-19.706-27.631-16.977c-6.681,2.766-1.566,27.566-7.515,31.546c-5.979,4.003-26.951-10.171-32.022-5.1
    		c-5.078,5.078,9.104,26.05,5.101,32.029c-3.98,5.942-28.788,0.834-31.561,7.508c-2.722,6.572,18.397,20.504,16.984,27.639
    		C24.873,122.622,0,127.423,0,134.747c0,7.325,24.873,12.126,26.242,19.048c1.412,7.134-19.707,21.06-16.977,27.631
    		c2.766,6.681,27.565,1.566,31.546,7.515c4.003,5.979-10.171,26.951-5.1,32.022c5.078,5.078,26.05-9.104,32.029-5.101
    		C71.464,218.358,76.938,233.447,77.604,241.753z"/>
    	<path d="M66.144,349.022H512l-52.453-217.304h-340.95L66.144,349.022z M473.934,319.049H367.579L361.3,251.61h96.351
    		L473.934,319.049z M435.948,161.691l16.282,67.439h-93.022l-6.271-67.439H435.948z M247.644,161.691h82.718l6.278,67.439h-95.275
    		L247.644,161.691z M239.272,251.61h99.46l6.271,67.439H233.001L239.272,251.61z M142.204,161.691h82.865l-6.271,67.439h-92.876
    		L142.204,161.691z M216.705,251.61l-6.279,67.439H104.218L120.5,251.61H216.705z"/>
    	<polygon points="83.634,394.479 494.511,394.479 512,359.508 66.144,359.508 	"/>
    	<polygon points="311.702,408.668 266.449,408.668 264.02,448.271 218.358,470.897 218.358,499.187 359.794,499.187 
    		359.794,470.897 314.131,448.271 	"/>
    </g>
    <text id="textDayNetDeliv" x="10" y="31" fill="#ba88ff" font-family="Arial" font-size="1.6px" stroke-linecap="round" stroke-width=".38" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">DayNetDeliv</text>
    <text id="textActualSolarToHome" x="34" y="25.5" fill="#4d4d4d" font-family="Arial" font-size="1.1px" stroke-linecap="round" stroke-width=".38" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">ActualSolarToHome</text>
    <g fill="none">
      <path id="SolarToNet" d="m29 17c0 9-2 11-12 12" stroke="#ffd000" stroke-width=".6"/>
      <path id="SolarToNet-flow" d="m29 17c0 9-2 11-12 12" stroke="#f00" stroke-linecap="round" stroke-width=".2"/>
      <path id="SolarToHome" d="m31 17c0 9 2 11 12 12" stroke="#ffd000" stroke-width=".6"/>
      <path id="SolarToHome-flow" d="m31 17c0 9 2 11 12 12" stroke="#f00" stroke-linecap="round" stroke-width=".2"/>
    </g>
    <g font-family="Arial" stroke-linecap="round" stroke-width=".38">
      <text id="textDaySolar" x="30" y="11.5" fill="#333333" font-size="1.6px" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">DaySolar</text>
      <text id="textActualSolar" x="30" y="14" fill="#333333" font-size="1.6px" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; font-weight: bold; white-space: pre;">ActualSolar</text>
      <text id="textActualSolarToNet" x="26" y="25.5" fill="#4d4d4d" font-size="1.1px" text-align="end" text-anchor="end" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">ActualSolarToNet</text>
    </g>
    <rect id="rectSolar" x="23" y="3" width="14" height="14" ry="7" fill="none" stroke="#ffd000" stroke-linecap="round" stroke-width=".3"/>
  </g>
  <g id="groupGas">
    <g transform="matrix(0.12, 0, 0, 0.12, 48, 6)">
      <path id="pathIconGas" d="M27.588 19.604q1.297 6.002-4.072 10.285-1.659 1.297-3.951 2.021-0.362 0.090-0.392 0.090 1.96-0.754 3.499-2.564 1.598-1.87 1.764-4.177t-1.041-4.358q-1.297-2.232-3.876-6.168t-3.484-5.384l-0.030 0.030q0-0.030-0.030-0.030-0.905 1.448-3.484 5.384t-3.876 6.168q-1.206 2.051-1.041 4.358t1.764 4.177q1.538 1.81 3.499 2.564-0.030 0-0.392-0.090-2.262-0.694-3.951-2.021-5.399-4.313-4.072-10.285 0.603-2.624 2.745-5.911 0.754-1.206 3.318-5.052t3.861-5.987q0.271-0.483 1.659-2.654 1.387 2.172 1.659 2.654 1.327 2.232 4.087 6.379t3.091 4.66q2.172 3.408 2.745 5.911zM19.596 28.2q-1.478 1.87-3.589 1.9-2.081-0.030-3.619-1.9-1.749-2.202-0.392-4.795 0.905-1.659 4.011-6.877 3.016 5.097 3.981 6.877 1.387 2.594-0.392 4.795z"></path>
    </g>
    <text id="textDayGas" x="50" y="13" fill="#333333" font-family="Arial" font-size="1.6px" stroke-linecap="round" stroke-width=".38" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre; font-weight: bold;">DayGas</text>
    <line id="GasToHome" x1="50" y1="17" x2="50" y2="23" style="stroke:#4d4d4d;stroke-width:0.6"/>
    <rect id="rectGas" x="43" y="3" width="14" height="14" ry="7" fill="none" stroke="#0ff" stroke-linecap="round" stroke-width=".3"/>
  </g>
  <g id="groupWater">
    <line id="WaterToHome" x1="50" y1="37" x2="50" y2="43" style="stroke:#4d4d4d;stroke-width:0.6"/>
    <g transform="matrix(0.25, 0, 0, 0.25, 48.55, 45.2)" style="">
      <path d="M11.08,6.06,6.58.19a.52.52,0,0,0-.8,0L1.28,6.06a6.18,6.18,0,1,0,10.44,6.49A6.13,6.13,0,0,0,11.08,6.06Zm-.26,6A5.07,5.07,0,0,1,6.18,15,5.08,5.08,0,0,1,1.54,12.1a5.08,5.08,0,0,1,.53-5.43L6.18,1.31l4.11,5.36A5.08,5.08,0,0,1,10.82,12.1ZM10.18,10a4,4,0,0,1-4,4,.5.5,0,0,1,0-1,3,3,0,0,0,3-3,.5.5,0,0,1,1,0Z"/>
    </g>
    <text id="textDayWater" x="50" y="52.5" fill="#333333" font-family="Arial" font-size="1.6px" stroke-linecap="round" stroke-width=".38" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre; font-weight: bold;">DayWater</text>
    <rect id="rectWater" x="43" y="43" width="14" height="14" ry="7" fill="none" stroke="#80c0f0" stroke-linecap="round" stroke-width=".3"/>
  </g>
  <g id="groupHome">
    <g transform="matrix(0.07, 0, 0, 0.07, 48, 24.5)">
      <path id="pathIconHome" d="M 12.6251 52.6445 L 43.3986 52.6445 C 46.7267 52.6445 48.6722 50.7695 48.6722 47.4648 L 48.6722 26.0664 L 51.6952 28.8320 C 52.1877 29.3008 52.7267 29.6289 53.3829 29.6289 C 54.4845 29.6289 55.3749 28.9492 55.3749 27.8242 C 55.3749 27.1211 55.1171 26.6758 54.6722 26.2774 L 46.5391 18.8476 L 46.5391 5.0430 C 46.5391 4.0117 45.8829 3.3555 44.8519 3.3555 L 41.7813 3.3555 C 40.7735 3.3555 40.0704 4.0117 40.0704 5.0430 L 40.0704 12.9648 L 30.8126 4.5274 C 29.9923 3.7774 29.0079 3.3555 28.0001 3.3555 C 26.9923 3.3555 26.0079 3.7774 25.1876 4.5274 L 1.3282 26.2774 C .9064 26.6758 .6251 27.1211 .6251 27.8242 C .6251 28.9492 1.5157 29.6289 2.6173 29.6289 C 3.2970 29.6289 3.8360 29.3008 4.3048 28.8320 L 7.3282 26.0898 L 7.3282 47.4648 C 7.3282 50.7695 9.2735 52.6445 12.6251 52.6445 Z M 34.7501 33.3086 C 34.7501 32.2305 34.0470 31.5508 32.9689 31.5508 L 23.0313 31.5508 C 21.9532 31.5508 21.2267 32.2305 21.2267 33.3086 L 21.2267 48.8711 L 13.4220 48.8711 C 11.9220 48.8711 11.1017 48.0508 11.1017 46.5273 L 11.1017 22.6445 L 27.1798 7.9961 C 27.4142 7.7617 27.6954 7.6211 28.0001 7.6211 C 28.3048 7.6211 28.5860 7.7383 28.8439 7.9961 L 44.8984 22.6445 L 44.8984 46.5273 C 44.8984 48.0508 44.0781 48.8711 42.6017 48.8711 L 34.7501 48.8711 Z"/>
    </g>    
    <line id="NetToHome" x1="17" y1="30" x2="43" y2="30" style="stroke:#77eaea;stroke-width:0.6"/>
    <line id="NetToHome-flow" x1="17" y1="30" x2="43" y2="30" style="stroke:red;stroke-width:0.2"/>
    <text id="textActualNetToHome" x="30.5" y="31.5" fill="#4d4d4d" font-size="1.1px" text-anchor="start" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">ActualNetToHome</text>
    <text id="textHomeToday" x="50" y="30.5" fill="#333333" font-size="1.6px" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">HomeToday</text>
    <text id="textHomeActual" x="50" y="33" fill="#333333" font-size="1.6px" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; font-weight: bold; white-space: pre;">HomeActual</text>
    <rect id="rectHome" x="43" y="23" width="14" height="14" ry="7" fill="none" stroke="#ff7bff" stroke-linecap="round" stroke-width=".3"/>
  </g>
  <g id="groupNet">
    <g id="pathIconNet" transform="matrix(0.006, 0, 0, 0.007, 8.6, 24)">
      <path d="M456.855,72.488L290.673,0h-124.49L0,72.488v62.348h149.276l-85.707,292.02H0.928v30h455v-30h-62.641l-85.707-292.02
      	h149.276V72.488z M184.312,30h88.232v74.836h-88.232V30z M180.542,134.836h95.772l14.531,49.508l-62.417,67.988l-62.417-67.988
      	L180.542,134.836z M30,104.836V92.133l124.312-54.225v66.928H30z M156.145,217.958l51.92,56.554L107.347,384.221L156.145,217.958z
      	 M108.933,426.855l119.495-130.162l119.495,130.162H108.933z M349.508,384.221L248.791,274.513l51.919-56.554L349.508,384.221z
      	 M426.855,104.836H302.544V37.908l124.312,54.225V104.836z"/>
    </g>    
    <text id="textDayNetUsage" x="10" y="29" fill="#4d4d4d" font-size="1.6px" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; white-space: pre;">DayNetUsage</text>
    <text id="textActualNet" x="10" y="33.6" fill="#333333" font-size="1.6px" text-anchor="middle" style="font-variant-caps: normal; font-variant-east-asian: normal; font-variant-ligatures: normal; font-variant-numeric: normal; font-weight: bold; white-space: pre;">ActualNet</text>
    <rect id="rectNet" x="3" y="23" width="14" height="14" ry="7" fill="none" stroke="#00c6da" stroke-linecap="round" stroke-width=".3"/>
  </g>
 </svg>
</div>

<script type="text/javascript" charset="utf-8">
// ---------------------------------------------------------------------------------------------------------------------------
// Start of customizable parameters
// ---------------------------------------------------------------------------------------------------------------------------
let idP1Meter = 1768;		// Change this value to be your ID for the Electricity Meter (P1)
let idGas = 1773;			// Change this value to be your ID for the Gas meter. Set to -1 when not used.
let idWater = 7935;			// Change this value to be your ID for the Water meter. Set to -1 when not used.
let idSolar = 8023;			// Change this value to be your ID for your Solar Power. Set to -1 when not used.
let idBattSetpoint = 9448;	// Change this value to be your ID for your Battery Watt. Set to -1 when not used.
let idBattSoc = 9454;		// Change this value to be your ID for your Battery SOC. Set to -1 when not used.
let sLocales = 'nl-NL';		// Update your locales. For more information see: https://www.w3schools.com/jsref/jsref_tolocalestring.asp
// ---------------------------------------------------------------------------------------------------------------------------
// End of customizable parameters
// ---------------------------------------------------------------------------------------------------------------------------


function updatePower() {
	let fDayNetUsage = 0, fDayNetDeliv = 0, fDaySolar = 0, fDayHomeUsage = 0,
		fActualNet = 0, fActualSolar = 0, fActualHomeUsage = 0,
		fActualNetToHome = 0, fActualSolarToNet = 0, fActualSolarToHome = 0,
		fDayGasUsage = 0, fDayWaterUsage = 0;

	let getPower = function() {
		return $.getJSON('/json.htm?type=command&param=getdevices&rid=' + idP1Meter, function(data){
			fDayNetUsage = parseFloat(data["result"][0]["CounterToday"].slice(0, -4).replace(',','.'));
			fDayNetDeliv = parseFloat(data["result"][0]["CounterDelivToday"].slice(0, -4).replace(',','.'));
			let fActualNetUsage = parseFloat(data["result"][0]["Usage"].slice(0, -5).replace(',','.'));
			let fActualNetDeliv = parseFloat(data["result"][0]["UsageDeliv"].slice(0, -5).replace(',','.'));
			fActualNet = fActualNetUsage - fActualNetDeliv;
		});
	}
	
	let getGas = function() {
		if (idGas>-1) {
			$.getJSON('/json.htm?type=command&param=getdevices&rid=' + idGas, function(data){
				fDayGasUsage = parseFloat(data["result"][0]["CounterToday"].slice(0, -3).replace(',','.'));
			});
		} else {
			fDayGasUsage = 0;
		}
	}

	let getWater = function() {
		if (idWater>-1) {
			$.getJSON('/json.htm?type=command&param=getdevices&rid=' + idWater, function(data){
				fDayWaterUsage = parseFloat(data["result"][0]["CounterToday"].slice(0, -3).replace(',','.'));
			});
		} else {
			fDayWaterUsage = 0;
		}
	}

	let getSolar = function() {
		if (idSolar != -1) {
			return $.getJSON('/json.htm?type=command&param=getdevices&rid=' + idSolar, function(data){
				fDaySolar = parseFloat(data["result"][0]["CounterToday"].slice(0, -4).replace(',','.'));
				fActualSolar = parseFloat(data["result"][0]["Usage"].slice(0, -5).replace(',','.'));
			});
		} else {
			fDaySolar = 0;
			fActualSolar = 0;
		}
	}

	let getBattSetpoint = function() {
		if (idBattSetpoint != -1) {
			return $.getJSON('/json.htm?type=command&param=getdevices&rid=' + idBattSetpoint, function(data){
				fActualBattWatt = data["result"][0]["Data"];
			});
		} else {
			fActualBattWatt = 0;
		}
	}
	
	let getBattSoc = function() {
		if (idBattSoc != -1 ) {
			return $.getJSON('/json.htm?type=command&param=getdevices&rid=' + idBattSoc, function(data){
				txtBattSoc = data["result"][0]["Data"];
			});
		} else {
			txtBattSoc = "-";
		}
	}

	function GetAnim(fPower, isReverse = false) {
			let fSec = 5 - fPower / 2000;
			fSec = (fSec<0.5) ? 0.5 : fSec;
			let ret = 'flow '+fSec.toFixed(1)+'s linear infinite';
			if (isReverse == true) {
				ret += " reverse";
			}
			return ret;
	}

	function UpdateScreen() {
		//Update Page
	
		//for debugging purposes
		//fActualNet = 21300;
		//fActualSolar = 2200;
		//fActualBattWatt = -500;
		//fDayGasUsage = 2.345;
		//fDayWaterUsage = 0.123;

		document.getElementById("textDayGas").textContent = fDayGasUsage.toLocaleString(sLocales) + ' m3';
		document.getElementById("textDayWater").textContent = fDayWaterUsage.toLocaleString(sLocales) + ' m3';
		document.getElementById("textDaySolar").textContent = fDaySolar.toLocaleString(sLocales) + ' kWh';
		document.getElementById("textActualSolar").textContent = fActualSolar.toLocaleString(sLocales) + ' Watt';
		document.getElementById("textTotalCharge").textContent = txtBattSoc;
		document.getElementById("textActualBatt").textContent = fActualBattWatt.toLocaleString(sLocales) + ' Watt';

		// Home usage: Calculated
		fDayHomeUsage = fDayNetUsage + fDaySolar - fDayNetDeliv;
		fActualHomeUsage = fActualSolar;
		if (fActualNet > 0) {
			fActualHomeUsage += fActualNet;
		}

		let BattNeededFromGrid = 0; //negative if batt is discharging
		let SolarToBatt = 0;
		let BattToHome = 0;

		if (fActualNet>0) {
			fActualNetToHome = fActualNet;
			fActualSolarToNet = 0;
			fActualSolarToHome = fActualSolar;
		} else {
			fActualNetToHome = 0;
			fActualSolarToNet = (fActualNet > 0) ? fActualNet : 0;
			if (fActualNet > 0) {
				fActualSolarToHome = fActualSolar - Math.abs(fActualNet);
			}
			else {
				fActualSolarToHome = fActualSolar;
				if (fActualBattWatt < 0) {
					let rest = (Math.abs(fActualNet) - Math.abs(fActualBattWatt));
					if (rest > 0) {
						fActualSolarToHome -= rest;
						fActualHomeUsage -= rest;
						fActualSolarToNet = rest;
					}
				} else {
					if (fActualBattWatt > 0) {
						let rest = fActualSolarToHome - (Math.abs(fActualNet) + Math.abs(fActualBattWatt));
						if (rest > 0) {
							fActualSolarToHome -= rest;
							fActualHomeUsage -= rest;
							fActualSolarToNet = rest;
						}
					}
				}
			}
		}

		//Update battery stats
		if (idBattSetpoint != -1) {
			if ((fActualBattWatt > 0) && (fActualSolar > 0)) {
				//some solar (if not all) is also charging the battery
				SolarToBatt = Math.min(fActualSolar, fActualBattWatt);
				fActualSolarToHome -= SolarToBatt;
				BattNeededFromGrid = fActualBattWatt - SolarToBatt;
				fActualHomeUsage -= SolarToBatt + BattNeededFromGrid;
				fActualNetToHome -= BattNeededFromGrid;
			} else if ((fActualBattWatt > 0) && (fActualSolar == 0)) {
				//we need all power from the grid
				BattNeededFromGrid = fActualBattWatt;
				if (1==1) {//fActualBattWatt < fActualNet) {
					fActualNetToHome -= BattNeededFromGrid;
					fActualHomeUsage -= BattNeededFromGrid;
				}
			}

			if (fActualBattWatt < 0) {
				//we are discharging
				if (fActualNet >= 0) {
					//we discharge all to home
					BattToHome = Math.abs(fActualBattWatt);
				} else {
					BattToHome = Math.max(Math.abs(fActualBattWatt) - Math.abs(fActualNet), 0);
				}
			}
			fActualHomeUsage += BattToHome;
			
			if (SolarToBatt > 0) {
				document.getElementById('SolarToBatt-flow').style.display = '';
				document.getElementById('SolarToBatt-flow').style.animation = GetAnim(SolarToBatt);
				document.getElementById("textSolarToBatt").textContent = SolarToBatt.toLocaleString(sLocales) + ' Watt';
			} else {
				document.getElementById('SolarToBatt-flow').style.display = 'none';
				document.getElementById("textSolarToBatt").textContent = '';
			}
			
			
			if (fActualBattWatt - SolarToBatt == 0) {
				document.getElementById('BattNet-flow').style.display = 'none';
				document.getElementById("textActualBattNet").textContent = '';
			} else {
				if (BattNeededFromGrid == 0) {
					if (fActualNet < 0) {
						document.getElementById('BattNet-flow').style.display = '';
						document.getElementById('BattNet-flow').style.animation = GetAnim(Math.abs(fActualNet));
						let battToNet = Math.abs(fActualNet);
						if (fActualBattWatt < 0) {
							 battToNet = Math.min(battToNet,Math.abs(fActualBattWatt));
						}
						document.getElementById("textActualBattNet").textContent = battToNet.toLocaleString(sLocales) + ' Watt';
					} else {
						document.getElementById('BattNet-flow').style.display = 'none';
						document.getElementById("textActualBattNet").textContent = '';
					}
				} else {
					if (fActualBattWatt > 0) {
						//charging battery
						document.getElementById('BattNet-flow').style.display = '';
						document.getElementById('BattNet-flow').style.animation = GetAnim(BattNeededFromGrid, true);
						document.getElementById("textActualBattNet").textContent = BattNeededFromGrid.toLocaleString(sLocales) + ' Watt';
					}
				}
			}
			if (BattToHome == 0) {
				document.getElementById('BattHome-flow').style.display = 'none';
				document.getElementById("textActualBattHome").textContent = '';
			} else {
				document.getElementById('BattHome-flow').style.display = '';
						document.getElementById('BattHome-flow').style.animation = GetAnim(BattToHome);
				document.getElementById("textActualBattHome").textContent = BattToHome.toLocaleString(sLocales) + ' Watt';;
			}
		}
		
		if (BattToHome > 0) {
			//if batery is discharging to Home, this means we are using all solar Power
			//fActualSolarToNet = 0;
			//fActualSolarToHome = fActualSolar;
			//fActualHomeUsage += BattToHome;
		}
		

		document.getElementById("textHomeToday").textContent = fDayHomeUsage.toLocaleString(sLocales) + ' kWh';
		document.getElementById("textHomeActual").textContent = fActualHomeUsage.toLocaleString(sLocales) + ' Watt';

		document.getElementById("textDayNetDeliv").textContent = '⇦ ' + fDayNetDeliv.toLocaleString(sLocales) + ' kWh';
		document.getElementById("textDayNetUsage").textContent = '⇨ ' + fDayNetUsage.toLocaleString(sLocales) + ' kWh';
		
		document.getElementById("textActualNet").textContent = fActualNet.toLocaleString(sLocales) + ' Watt';
		
		if (fActualNetToHome==0) {
			document.getElementById('NetToHome-flow').style.display = 'none';
			document.getElementById("textActualNetToHome").textContent = '';
		} else {
			document.getElementById('NetToHome-flow').style.display = '';
			document.getElementById('NetToHome-flow').style.animation = GetAnim(fActualNetToHome);	
			document.getElementById("textActualNetToHome").textContent = fActualNetToHome.toLocaleString(sLocales) + ' Watt';
		}

		if (fActualSolarToNet==0) {
			document.getElementById('SolarToNet-flow').style.display = 'none';
			document.getElementById("textActualSolarToNet").textContent = '';
		} else {
			document.getElementById('SolarToNet-flow').style.display = '';
			document.getElementById('SolarToNet-flow').style.animation = GetAnim(fActualSolarToNet);	
			document.getElementById("textActualSolarToNet").textContent = fActualSolarToNet.toLocaleString(sLocales) + ' Watt';
		}

		if (fActualSolarToHome==0) {
			document.getElementById('SolarToHome-flow').style.display = 'none';
			document.getElementById("textActualSolarToHome").textContent = '';
		} else {
			document.getElementById('SolarToHome-flow').style.display = '';
			document.getElementById('SolarToHome-flow').style.animation = GetAnim(fActualSolarToHome);
			document.getElementById("textActualSolarToHome").textContent = fActualSolarToHome.toLocaleString(sLocales) + ' Watt';
		}
	}
	
	// Update All
	$.when(getPower(), getGas(), getWater(), getSolar(), getBattSetpoint(), getBattSoc()).done(UpdateScreen);
}

$(document).ready( function() {
	if (idGas == -1) { $('#groupGas').hide(); }
	if (idSolar == -1) { $('#groupSolar').hide(); }
	if ((idBattSetpoint == -1)||(idBattSoc == -1)) { 
		$('#groupBatt').hide();
	}
	updatePower();
	setInterval(function(){ updatePower(); }, 5000);	
});
</script>